<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-16" />
        <title>Teameet</title>
        <style>
            body {
                margin: 0;
                padding: 0;
                font-family: Arial, Helvetica, sans-serif;
            }

            h1 {
                text-align: center;
                text-decoration: underline;
            }
            .account{
                position: fixed;
                right: 50px;
                top: 20px;
                background-color: #bebefe;
                text-decoration: none;
                color: purple;
                padding: 0.4rem;
            }
            #projectstable{
                margin-left: 5vw;
                padding: 0;
                table-layout: fixed;
            }
            .projecttableheader{
                text-align: left;
            }
            .projectname{
                width: 15vw;
            }
            .projectowner{
                width: 15vw;
            }
            .projectdescription{
                width: 30vw;
            }
            .projectlanguages{
                width: 30vw;
            }
            .projectrow:hover{
                background-color: #bebebe
            }
            .projectrow{
                width: 90vw;
                height: 50px;
            }
            .projectcolumndiv{
                max-height: 50px;
                overflow: hidden;
                text-overflow: ellipsis;
            }
        </style>
        <script>
            function makeVisit(id) {
                return () => {visit(id);};
            }
            function visit(project) {
                window.location.href = "/project/?p="+project;
            }
            function getDataAndLogin() {
                const pw = document.querySelector("#loginPassword").value;
                const mail = document.querySelector("#loginEmail").value;
                login(mail, pw, "/");
            }
            function login(mail, pw, redirect) {
                fetch("/api/login", {
                    method: "POST",
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: mail,
                        password: pw
                    })
                }).then(r => r.json()).then(r => {
                    if (r.status == 200) {
                        window.location.href = redirect;
                    } else {
                        document.writeln("there has been a problem with your login\n\
probably your username and/or password was incorrect");
                    }
                });
            }
            (async () => {
                const p = await fetch("/api/projects").then(r => r.json());
                const projectList = p.body["projects"];
                const table = document.querySelector("#projectstablebody");
                const template = document.querySelector("#projecttemplate");
                projectList.forEach(project => {
                    let clone = document.importNode(template.content, true);
                    clone.querySelector(".projectname").innerText = project.name;
                    clone.querySelector(".projectowner").innerText = project.owner;
                    clone.querySelector(".projectdescription").innerText = project.description;
                    clone.querySelector(".projectlanguages").innerText = project.languages;
                    clone.querySelector(".projectrow").onclick = makeVisit(project.id);
                    table.appendChild(clone);
                });
                document.querySelector("#loginButton")?.addEventListener("onsubmit", event => {
                    event.preventDefault();
                });
                document.querySelector("#loginButton")?.addEventListener("onclick", event => {
                    event.preventDefault();
                });
            })();
        </script>
    </head>
    <body>
        <head>
            <h1>Welcome to Teameet</h1>
        </head>
        <main>
            <div id="main">
                <div id="projectsdiv">
                    <div id="projectscontainer">
                        <table id="projectstable">
                            <span id="projectsheading">Projects: </span>
                            <tbody id="projectstablebody">
                                <tr id="projectsrowheader">
                                    <th class="projecttableheader projectname">name</th>
                                    <th class="projecttableheader projectowner">owner</th>
                                    <th class="projecttableheader projectdescription">description</th>
                                    <th class="projecttableheader projectlanguages">technologies</th>
                                </tr>
                            </tbody>
                                <template id="projecttemplate">
                                    <tr class="projectrow">
                                        <td class="projectcolumn">
                                            <div class="projectcolumndiv projectname"></div>
                                        </td>
                                    <td class="projectcolumn">
                                        <div class="projectcolumndiv projectowner"></div>
                                    </td>
                                    <td class="projectcolumn">
                                        <div class="projectcolumndiv projectdescription"></div>
                                    </td>
                                    <td class="projectcolumn">
                                        <div class="projectcolumndiv projectlanguages"></div>
                                    </td>
                                </tr>
                            </template>
                        </table>
                    </div>
                </div>
                <div>
                    <p>
                        <a class="account" id="login" style="display:none;" href='/login'>login</a>
                        <!--<button onclick="location.href = '/login'">login</button>-->
                    </p>
                    <p>
                        <a class="account" id="profile" style="display:none;">profile</a>
                        <!--<button onclick="location.href = '/login'">login</button>-->
                    </p>
                </div>
                <script>
                    fetch("/api/login").then(r => r.json()).then(r => {
                        if (r.status != 200) {
                            document.querySelector("#login").style.display = "";
                        } else {
                            let element = document.querySelector("#profile");
                            element.href = "/profile?id="+r.body.id
                            element.style.display = "";
                        }
                    });
                </script>
            </div>
        </main>
    </body>

</html>