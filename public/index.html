<!DOCTYPE html>
<html>

<head>
    <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/skeleton/2.0.4/skeleton.min.css" integrity="sha512-EZLkOqwILORob+p0BXZc+Vm3RgJBOe1Iq/0fiI7r/wJgzOFZMlsqTa29UEl6v6U6gsV4uIpsNZoV32YZqrCRCQ==" crossorigin="anonymous" referrerpolicy="no-referrer" /> -->
    <meta charset="UTF-8" />
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <title>Teameet</title>
    <link rel="stylesheet" href="/globalstyle.css" />
    <style>
        h1 {
            text-align: center;
            text-decoration: underline;
        }

        #projectstable {
            margin-left: 5vw;
            margin-bottom: 5vw;
            padding: 0;
            table-layout: fixed;
        }

        .projecttableheader {
            text-align: left;
        }

        .projectname {
            width: 15vw;
        }

        .projectowner {
            width: 15vw;
        }

        .projectdescription {
            width: 30vw;
        }

        .projectlanguages {
            width: 30vw;
        }

        .projectrow:hover {
            background-color: var(--primary-color);
            color: var(--secondary-color);
        }

        .projectrow {
            width: 90vw;
            height: 40px;
        }

        .projectcolumndiv {
            max-height: 45px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .projectcolumndiv:hover {
            cursor: default;
        }

        #newproj {
            margin-left: 5vw;
            margin-right: 0;
        }
    </style>
    <script>
        function makeVisit(id) {
            return () => { visit(id); };
        }
        function visit(project) {
            window.location.href = "/project/?id=" + project;
        }
        function getDataAndLogin() {
            const pw = document.querySelector("#loginPassword").value;
            const mail = document.querySelector("#loginEmail").value;
            login(mail, pw, "/");
        }
        function login(mail, pw, redirect) {
            fetch("/api/login", {
                method: "POST",
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    email: mail,
                    password: pw
                })
            }).then(r => r.json()).then(r => {
                if (r.status == 200) {
                    window.location.href = redirect;
                } else {
                    document.writeln("there has been a problem with your login\n\
probably your username and/or password was incorrect");
                }
            });
        }
        (async () => {
            const p = await fetch("/api/project").then(r => r.json());
            const projectList = p.body["projects"];
            const table = document.querySelector("#projectstablebody");
            const template = document.querySelector("#projecttemplate");
            projectList.forEach(project => {
                let clone = document.importNode(template.content, true);
                clone.querySelector(".projectname").innerText = project.name;
                clone.querySelector(".projectowner").innerText = project.owner;
                clone.querySelector(".projectdescription").innerText = project.description;
                clone.querySelector(".projectlanguages").innerText = project.languages;
                clone.querySelector(".projectrow").onclick = makeVisit(project.id);
                table.appendChild(clone);
            });
            document.querySelector("#loginButton")?.addEventListener("onsubmit", event => {
                event.preventDefault();
            });
            document.querySelector("#loginButton")?.addEventListener("onclick", event => {
                event.preventDefault();
            });
        })();
    </script>
</head>

<body>

    <head>
        <h1>Welcome to Teameet</h1>
    </head>
    <main>
        <div id="main">
            <div id="projectsdiv">
                <div id="projectscontainer">
                    <table id="projectstable">
                        <tbody id="projectstablebody">
                            <tr id="projectsrowheader">
                                <th class="projecttableheader projectname">name</th>
                                <th class="projecttableheader projectowner">owner</th>
                                <th class="projecttableheader projectdescription">description</th>
                                <th class="projecttableheader projectlanguages">technologies</th>
                            </tr>
                        </tbody>
                        <template id="projecttemplate">
                            <tr class="projectrow">
                                <td class="projectcolumn">
                                    <div class="projectcolumndiv projectname"></div>
                                </td>
                                <td class="projectcolumn">
                                    <div class="projectcolumndiv projectowner"></div>
                                </td>
                                <td class="projectcolumn">
                                    <div class="projectcolumndiv projectdescription"></div>
                                </td>
                                <td class="projectcolumn">
                                    <div class="projectcolumndiv projectlanguages"></div>
                                </td>
                            </tr>
                        </template>
                    </table>
                </div>
                <div id="newproj">
                    <a class="button" id="newproj-button" href="login?ref=/project/new">
                        create a new Project
                    </a>
                </div>
            </div>
            <div>
                <p>
                    <a class="account button" id="login" style="display: none;" href='/login?ref=/'>login</a>
                </p>
                <p>
                    <a class="account button" id="profile" style="display: none;"></a>
                </p>
            </div>
            <script>
                fetch("/api/login").then(r => r.json()).then(r => {
                    if (r.status != 200) {
                        document.querySelector("#login").style.display = "";
                    } else {
                        let element = document.querySelector("#profile");
                        element.href = "/profile/?id=" + r.body.uuid;
                        element.style.display = "";
                        element.innerText = r.body.name;
                    }
                });
            </script>
        </div>
    </main>
</body>

</html>